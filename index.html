<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Universal Shuffle Playlist</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body {
    font-family: system-ui, sans-serif;
    background: #111;
    color: #eee;
    text-align: center;
    padding: 20px;
  }

  h1 {
    margin-bottom: 10px;
  }

  button, input[type="file"] {
    margin: 10px;
    padding: 10px 16px;
    font-size: 16px;
    cursor: pointer;
  }

  #player {
    margin-top: 20px;
  }

  iframe, video, audio {
    width: 100%;
    max-width: 560px;
    margin-top: 15px;
  }

  video {
    max-height: 315px;
  }

  a {
    color: #7aa2ff;
    word-break: break-all;
  }
</style>
</head>

<body>

<h1>ðŸ”€ Universal Shuffle Playlist</h1>
<p>Upload a playlist file, then let it roll.</p>

<input type="file" accept=".txt,.json" onchange="loadPlaylist(event)">
<br>
<button onclick="shuffle()">Shuffle</button>

<div id="player"></div>

<!-- YouTube IFrame API -->
<script src="https://www.youtube.com/iframe_api"></script>

<script>
let playlist = [];
let ytPlayer = null;
let ytReady = false;

// Required by YouTube API
function onYouTubeIframeAPIReady() {
  ytReady = true;
}

function loadPlaylist(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    const text = e.target.result;

    try {
      playlist = JSON.parse(text);
    } catch {
      playlist = text
        .split("\n")
        .map(l => l.trim())
        .filter(l => l.length > 0);
    }

    alert(`Loaded ${playlist.length} items ðŸŽ¶`);
  };

  reader.readAsText(file);
}

function shuffle() {
  if (playlist.length === 0) {
    alert("Upload a playlist first!");
    return;
  }

  const url = playlist[Math.floor(Math.random() * playlist.length)];
  const player = document.getElementById("player");
  player.innerHTML = "";

  // ---------- YOUTUBE ----------
  if (url.includes("youtube.com") || url.includes("youtu.be")) {
    const videoId = extractYouTubeID(url);
    if (!videoId) {
      player.innerHTML = "<p>Invalid YouTube link ðŸ˜¢</p>";
      return;
    }

    if (!ytReady) {
      player.innerHTML = "<p>YouTube player not ready yetâ€¦ try again.</p>";
      return;
    }

    player.innerHTML = `<div id="yt-player"></div>`;

    ytPlayer = new YT.Player("yt-player", {
      videoId: videoId,
      playerVars: {
        autoplay: 1,
        playsinline: 1
      },
      events: {
        onStateChange: onYTStateChange
      }
    });

    return;
  }

  // ---------- DIRECT VIDEO ----------
  if (url.match(/\.(mp4|webm|ogg)$/i)) {
    const video = document.createElement("video");
    video.src = url;
    video.controls = true;
    video.autoplay = true;

    // Desktop-friendly auto-advance (may pause on iOS)
    video.addEventListener("ended", shuffle);

    player.appendChild(video);
    return;
  }

  // ---------- DIRECT AUDIO ----------
  if (url.match(/\.(mp3|wav|m4a|ogg)$/i)) {
    const audio = document.createElement("audio");
    audio.src = url;
    audio.controls = true;
    audio.autoplay = true;

    audio.addEventListener("ended", shuffle);

    player.appendChild(audio);
    return;
  }

  // ---------- FALLBACK ----------
  player.innerHTML = `
    <p>Can't embed this link, but you can open it:</p>
    <a href="${url}" target="_blank">${url}</a>
  `;
}

function onYTStateChange(event) {
  if (event.data === YT.PlayerState.ENDED) {
    shuffle(); // âœ… AUTO-ADVANCE FOR YOUTUBE
  }
}

function extractYouTubeID(url) {
  const regExp =
    /(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
  const match = url.match(regExp);
  return match ? match[1] : null;
}
</script>

</body>
</html>
